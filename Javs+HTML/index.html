<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Digit Recognizer - Improved Template Matching</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  h1 {
    margin-bottom: 20px;
  }
  canvas {
    border: 2px solid #fff;
    background: #fff;
    cursor: crosshair;
    margin-bottom: 20px;
  }
  .controls {
    margin-bottom: 20px;
  }
  .controls button {
    margin: 0 10px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 5px;
  }
  .controls button:hover {
    background: #555;
  }
  #result {
    font-size: 24px;
    min-height: 30px;
  }
</style>
</head>
<body>

<h1>Digit Recognizer - Improved Template Matching</h1>
<canvas id="drawingCanvas" width="280" height="280"></canvas>
<div class="controls">
  <button id="clearBtn">Clear</button>
  <button id="recognizeBtn">Recognize</button>
</div>
<div id="result">Draw a digit and click Recognize</div>

<script>
class DrawingApp {
  constructor() {
    this.canvas = document.getElementById('drawingCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.isDrawing = false;
    this.lastX = 0;
    this.lastY = 0;

    this.setupEvents();
    this.clearCanvas();
  }

  setupEvents() {
    this.canvas.addEventListener('mousedown', e => {
      this.isDrawing = true;
      [this.lastX, this.lastY] = [e.offsetX, e.offsetY];
    });
    this.canvas.addEventListener('mousemove', e => {
      if (!this.isDrawing) return;
      this.ctx.strokeStyle = "#000";
      this.ctx.lineWidth = 20;
      this.ctx.lineCap = "round";
      this.ctx.beginPath();
      this.ctx.moveTo(this.lastX, this.lastY);
      this.ctx.lineTo(e.offsetX, e.offsetY);
      this.ctx.stroke();
      [this.lastX, this.lastY] = [e.offsetX, e.offsetY];
    });
    this.canvas.addEventListener('mouseup', () => this.isDrawing = false);
    this.canvas.addEventListener('mouseout', () => this.isDrawing = false);

    document.getElementById('clearBtn').addEventListener('click', () => this.clearCanvas());
    document.getElementById('recognizeBtn').addEventListener('click', () => this.recognize());
  }

  clearCanvas() {
    this.ctx.fillStyle = "#fff";
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    document.getElementById('result').textContent = 'Draw a digit and click Recognize';
  }

  recognize() {
    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
    const grayImage = this.toGrayImage(imageData);

    // Crop digit bounding box
    const cropped = cropBoundingBox(grayImage);

    // Resize to 28x28 with centering & proportional scale
    const resized = resizeAndCenter(cropped, 28, 28);

    // Match templates
    const guess = matchTemplates(resized);

    // Bounding box heuristic adjustment
    const bbox = getBoundingBox(grayImage);
    const adjustedGuess = applyHeuristics(guess, bbox);

    document.getElementById('result').textContent = `Guess: ${adjustedGuess}`;
  }

  // Convert image data to grayscale 0.0-1.0 (white=0, black=1)
  toGrayImage(imageData) {
    const { data, width, height } = imageData;
    const gray = new Array(width * height);
    for (let i = 0; i < width * height; i++) {
      const r = data[i * 4];
      const g = data[i * 4 + 1];
      const b = data[i * 4 + 2];
      const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
      gray[i] = (255 - brightness) / 255; // invert: white=0, black=1
    }
    return { data: gray, width, height };
  }
}

// Crop image to bounding box of pixels above threshold
function cropBoundingBox(image, threshold = 0.05) {
  const { data, width, height } = image;
  let minX = width, maxX = 0, minY = height, maxY = 0;
  let found = false;

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      if (data[y * width + x] > threshold) {
        found = true;
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }
  }

  if (!found) return image;

  const w = maxX - minX + 1;
  const h = maxY - minY + 1;
  const croppedData = new Array(w * h);

  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {
      croppedData[y * w + x] = data[(minY + y) * width + (minX + x)];
    }
  }

  return { data: croppedData, width: w, height: h };
}

// Resize with centering and proportional scale to targetWidth x targetHeight
function resizeAndCenter(image, targetWidth, targetHeight) {
  const { data, width, height } = image;

  const scale = Math.min(targetWidth / width, targetHeight / height);

  const newWidth = Math.round(width * scale);
  const newHeight = Math.round(height * scale);

  const outputData = new Array(targetWidth * targetHeight).fill(0);

  for (let y = 0; y < newHeight; y++) {
    for (let x = 0; x < newWidth; x++) {
      const srcX = Math.floor(x / scale);
      const srcY = Math.floor(y / scale);
      const val = data[srcY * width + srcX];

      const offsetX = Math.floor((targetWidth - newWidth) / 2);
      const offsetY = Math.floor((targetHeight - newHeight) / 2);

      outputData[(y + offsetY) * targetWidth + (x + offsetX)] = val;
    }
  }

  return { data: outputData, width: targetWidth, height: targetHeight };
}

// Calculate bounding box of grayscale image pixels above threshold
function getBoundingBox(image, threshold = 0.05) {
  const { data, width, height } = image;
  let minX = width, maxX = 0, minY = height, maxY = 0;
  let found = false;
  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      if (data[y * width + x] > threshold) {
        found = true;
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }
  }
  if (!found) return null;
  return { minX, maxX, minY, maxY, width: maxX - minX + 1, height: maxY - minY + 1 };
}

// Multiple templates per digit (28x28 grayscale arrays, values 0 or 1)
const digitTemplates = {
  0: [
    // Classic 0
    [
      "0000011111111100000000000000",
      "0001111111111111000000000000",
      "0011111111111111110000000000",
      "0111110000000111111000000000",
      "1111100000000001111100000000",
      "1111000000000000111100000000",
      "1111000000000000111100000000",
      "1111000000000000111100000000",
      "1111000000000000111100000000",
      "1111000000000000111100000000",
      "1111100000000001111100000000",
      "1111110000000111111000000000",
      "0111111111111111110000000000",
      "0011111111111111000000000000",
      "0000111111111100000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000"
    ]
  ],
  1: [
    // Thin vertical line 1
    [
      "0000000011100000000000000000",
      "0000000111100000000000000000",
      "0000001111100000000000000000",
      "0000011111100000000000000000",
      "0000111111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000"
    ],
    // Slight slant variant
    [
      "0000000011100000000000000000",
      "0000000111100000000000000000",
      "0000001111100000000000000000",
      "0000011111100000000000000000",
      "0000111111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000111100000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000"
    ],
    // With small serif at bottom
    [
      "0000000011100000000000000000",
      "0000000111100000000000000000",
      "0000001111100000000000000000",
      "0000011111100000000000000000",
      "0000111111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111100000000000000000",
      "0000001111111110000000000000",
      "0000000000111100000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000",
      "0000000000000000000000000000"
    ]
  ],
  // Add more digits 2-9 here, single template for brevity (you can add multiple)
  2: [[
    "0000111111111100000000000000",
    "0001111111111110000000000000",
    "0011110000001111000000000000",
    "0111100000000111100000000000",
    "0000000000001111000000000000",
    "0000000000011110000000000000",
    "0000000000111100000000000000",
    "0000000001111000000000000000",
    "0000000011110000000000000000",
    "0000000111100000000000000000",
    "0000001111000000000000000000",
    "0000011110000000000000000000",
    "0000111100000000000000000000",
    "0001111000000000000000000000",
    "0011111111111111000000000000",
    "0011111111111111000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  3: [[
    "0001111111111000000000000000",
    "0011111111111100000000000000",
    "0111000000111100000000000000",
    "0000000000111100000000000000",
    "0000000001111000000000000000",
    "0000000011110000000000000000",
    "0000000111100000000000000000",
    "0000001111000000000000000000",
    "0000011110000000000000000000",
    "0000011110000000000000000000",
    "0000011110000000000000000000",
    "0000011110000000000000000000",
    "0000011110000000000000000000",
    "0000011110000000000000000000",
    "0000001111110000000000000000",
    "0000000111100000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  4: [[
    "0000000001111000000000000000",
    "0000000011111000000000000000",
    "0000000111111000000000000000",
    "0000001111111000000000000000",
    "0000011111111000000000000000",
    "0000111111111000000000000000",
    "0001111111111000000000000000",
    "0011111001111000000000000000",
    "0111110001111000000000000000",
    "1111100001111000000000000000",
    "1111100001111000000000000000",
    "1111111111111111111000000000",
    "1111111111111111111000000000",
    "1111111111111111111000000000",
    "0000000001111000000000000000",
    "0000000001111000000000000000",
    "0000000001111000000000000000",
    "0000000001111000000000000000",
    "0000000001111000000000000000",
    "0000000001111000000000000000",
    "0000000001111000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  5: [[
    "0000111111110000000000000000",
    "0001111111111000000000000000",
    "0011110001111100000000000000",
    "0111100000111110000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "0111100000111110000000000000",
    "0011111111111100000000000000",
    "0001111111111000000000000000",
    "0000111100111000000000000000",
    "0000000000000000000000000000",
    "0001111111111000000000000000",
    "0011110001111100000000000000",
    "0111100000111110000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "0111100000111110000000000000",
    "0011110001111100000000000000",
    "0001111111111000000000000000",
    "0000111111110000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  6: [[
    "0000011111111000000000000000",
    "0001111111111100000000000000",
    "0011110000111100000000000000",
    "0111100000011100000000000000",
    "1111000000000000000000000000",
    "1111000000000000000000000000",
    "1111000000000000000000000000",
    "1111111111111000000000000000",
    "1111111111111100000000000000",
    "1111000000011110000000000000",
    "1111000000001111000000000000",
    "1111000000000111000000000000",
    "0111100000001110000000000000",
    "0011110000011110000000000000",
    "0001111111111100000000000000",
    "0000111111111000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  7: [[
    "1111111111111111111111100000",
    "1111111111111111111111100000",
    "0000000000000000000111100000",
    "0000000000000000001111000000",
    "0000000000000000011110000000",
    "0000000000000000111100000000",
    "0000000000000001111000000000",
    "0000000000000011110000000000",
    "0000000000000111100000000000",
    "0000000000001111000000000000",
    "0000000000011110000000000000",
    "0000000000011110000000000000",
    "0000000000011110000000000000",
    "0000000000011110000000000000",
    "0000000000011110000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  8: [[
    "0000011111110000000000000000",
    "0001111111111000000000000000",
    "0011110001111100000000000000",
    "0111100000111110000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "0111100000111110000000000000",
    "0011111111111110000000000000",
    "0001111111111110000000000000",
    "0000111100111100000000000000",
    "0000000000111100000000000000",
    "0000111100111100000000000000",
    "0011110001111100000000000000",
    "0111100000111110000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "1111000000011111000000000000",
    "0111100000111110000000000000",
    "0011111111111110000000000000",
    "0001111111111110000000000000",
    "0000111111111100000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]],
  9: [[
    "0000111111110000000000000000",
    "0001111111111000000000000000",
    "0011110000111100000000000000",
    "0111100000011110000000000000",
    "1111000000001111000000000000",
    "1111000000001111000000000000",
    "1111000000001111000000000000",
    "0111100000011111000000000000",
    "0011111111111110000000000000",
    "0001111111111100000000000000",
    "0000111100000000000000000000",
    "0000000000000000000000000000",
    "0001111111111100000000000000",
    "0011110001111100000000000000",
    "0111100000111100000000000000",
    "1111000000011110000000000000",
    "1111000000011110000000000000",
    "1111000000011110000000000000",
    "0111100000111110000000000000",
    "0011110001111110000000000000",
    "0001111111111100000000000000",
    "0000111111111000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000",
    "0000000000000000000000000000"
  ]]
};

// Convert templates to numerical grayscale arrays (0 or 1)
const digitTemplatesGrayscale = {};
for (const digit in digitTemplates) {
  digitTemplatesGrayscale[digit] = digitTemplates[digit].map(template =>
    template.map(row => row.split('').map(ch => ch === '1' ? 1 : 0)).flat()
  );
}

// Compute sum of absolute differences between two 28x28 grayscale arrays
function grayscaleDifference(img1, img2) {
  let diff = 0;
  for (let i = 0; i < 28 * 28; i++) {
    diff += Math.abs(img1[i] - img2[i]);
  }
  return diff;
}

// Match templates: iterate all templates for each digit, pick minimal diff overall
function matchTemplates(image) {
  let bestDigit = null;
  let bestDiff = Infinity;
  const inputData = image.data;

  for (const digit in digitTemplatesGrayscale) {
    for (const template of digitTemplatesGrayscale[digit]) {
      const diff = grayscaleDifference(inputData, template);
      if (diff < bestDiff) {
        bestDiff = diff;
        bestDigit = digit;
      }
    }
  }
  return parseInt(bestDigit);
}

// Apply simple heuristics to adjust guess based on bounding box shape
function applyHeuristics(guess, bbox) {
  if (!bbox) return guess; // no bbox info

  const aspectRatio = bbox.width / bbox.height;

  // Heuristic for digit '1': tall & narrow
  if (guess === 1 && (aspectRatio > 0.5)) {
    // If aspect ratio too wide for '1', maybe it's 7 or 4? Penalize '1'
    return 7; // or fallback, you can tweak this
  }
  // Heuristic for digit '7': wider aspect ratio than '1'
  if (guess === 7 && (aspectRatio < 0.3)) {
    return 1;
  }

  // Heuristic for digit '4': has vertical & horizontal parts
  // (could be improved later with stroke counts)

  return guess;
}

// Init app
window.onload = () => {
  window.app = new DrawingApp();
};
</script>

</body>
</html>

